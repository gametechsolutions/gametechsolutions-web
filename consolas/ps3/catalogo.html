<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cat√°logo de juegos | GameTechSolutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Base global -->
  <link rel="stylesheet" href="/styles/theme-base.css">

  <!-- Tema de consola -->
  <link rel="stylesheet" href="/styles/theme-nintendo.css"
</head>
<body>

<!-- HEADER -->
<header>
  <div>
    <h1>Cat√°logo <span id="consoleName"></span></h1>
    <p>
      Selecci√≥n de juegos disponibles para <strong class="consoleFull"></strong>
    </p>

    <nav>
      <input type="checkbox" id="menu-toggle" class="menu-toggle">
      <label for="menu-toggle" class="menu-icon">‚ò∞</label>

      <ul class="nav-menu">
        <li><a href="/">Inicio</a></li>

        <li tabindex="0">
          <span class="menu-parent">Sony ‚ñæ</span>
          <ul class="submenu">
            <li><a href="/consolas/ps2/">üéÆ PlayStation 2</a></li>
            <li><a href="/consolas/ps3/">üéÆ PlayStation 3</a></li>
          </ul>
        </li>

        <li tabindex="0">
          <span class="menu-parent">Microsoft ‚ñæ</span>
          <ul class="submenu">
            <li><a href="/consolas/xbox360/">üéÆ Xbox 360</a></li>
          </ul>
        </li>

        <li tabindex="0">
          <span class="menu-parent">Nintendo ‚ñæ</span>
          <ul class="submenu">
            <li><a href="/consolas/wii/">üéÆ Nintendo Wii</a></li>
            <li><a href="/consolas/gamecube/">üéÆ Nintendo GameCube</a></li>
          </ul>
        </li>

        <li><a href="/contacto/">Contacto</a></li>
      </ul>
    </nav>
  </div>
</header>

<!-- CONTENIDO -->
<main>
  <div class="container">

    <!-- INTRO -->
    <section>
      <h2>¬øC√≥mo funciona el cat√°logo?</h2>
      <p>
        Desde aqu√≠ puedes consultar los juegos disponibles para <strong class="consoleFull"></strong>.
        La cantidad final de juegos instalados depende del tama√±o del disco duro
        y del peso de cada t√≠tulo.
      </p>
      <p>
        Este cat√°logo sirve como referencia para que elijas tus juegos
        al momento de contratar el servicio.
      </p>
    </section>

    <!-- NOTAS -->
    <section>
      <h2>Notas importantes</h2>
      <div class="cards-grid">
        <div class="card">
          <h3>üíæ Espacio disponible</h3>
          <p>No todos los juegos caben en todos los discos.</p>
        </div>
        <div class="card">
          <h3>‚ö†Ô∏è Compatibilidad</h3>
          <p>Algunos t√≠tulos pueden requerir configuraciones especiales.</p>
        </div>
        <div class="card">
          <h3>üõ°Ô∏è Garant√≠a</h3>
          <p>Los juegos instalados cuentan con garant√≠a de 30 d√≠as.</p>
        </div>
      </div>
    </section>

    <!-- TOP JUEGOS -->
    <section>
      <h2>Juegos m√°s populares</h2>
      <p>
        Contamos con un amplio cat√°logo que incluye muchos de los t√≠tulos
        m√°s populares de <strong class="consoleFull"></strong>.
      </p>

      <div class="cards-grid">

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps3/top/gta-iv.jpg" alt="GTA IV">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Grand Theft Auto IV</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps3/top/gta-v.jpg" alt="GTA V">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Grand Theft Auto V</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps3/top/uncharted2.jpg" alt="Uncharted 2">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Uncharted 2</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps3/top/batman-city.jpg" alt="Batman Arkham City">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Batman Arkham City</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps3/top/littlebigplanet.jpg" alt="Little Big Planet">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Little Big Planet</h3>
        </div>

      </div>
    </section>

    <section>
      <h2>Selecciona el tama√±o del disco duro</h2>
      <p>
        Elige el tama√±o del disco duro de tu consola o el que deseas instalar.
        La capacidad usable es aproximada y considera el espacio del sistema.
      </p>
    
      <div class="disk-selector">
    
        <label class="disk-option">
          <input type="radio" name="diskSize">
          <div>
            <strong>80 GB</strong>
            <span>Recomendado: ~10 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize" value="120" data-limit="105">
          <div>
            <strong>120 GB</strong>
            <span>Recomendado: ~15 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize">
          <div>
            <strong>160 GB</strong>
            <span>Recomendado: ~20 juegos</span>
          </div>
        </label>

        <label class="disk-option">
          <input type="radio" name="diskSize" value="250" data-limit="226">
          <div>
            <strong>250 GB</strong>
            <span>Recomendado: ~25 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize" value="320" data-limit="293">
          <div>
            <strong>320 GB</strong>
            <span>Recomendado: ~35 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize" value="500" data-limit="460">
          <div>
            <strong>500 GB</strong>
            <span>Recomendado: ~50 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize" value="750" data-limit="690">
          <div>
            <strong>750 GB</strong>
            <span>Recomendado: ~75 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize" value="1000" data-limit="926">
          <div>
            <strong>1 TB</strong>
            <span>Recomendado: ~100 juegos</span>
          </div>
        </label>
    
      </div>
    
      <p class="disk-note">
        üí° La cantidad de juegos es solo una referencia. El l√≠mite real se determina por el espacio en GB.
      </p>
    </section>

    <!-- SELECTOR -->
    <section>
      <h2>Selector de juegos</h2>
      <p>Selecciona los juegos que te gustar√≠a instalar.</p>

      <div class="selector-layout">

        <!-- CAT√ÅLOGO -->
        <div class="selector-catalog">
          <h3>Cat√°logo</h3>

        </div>

        <!-- RESUMEN -->
        <div class="selector-summary">
          <h3>Mi selecci√≥n</h3>

          <p>üéÆ Juegos seleccionados: <strong id="gameCount">0</strong></p>
          <p>üíæ Espacio estimado: <strong id="totalSize">0</strong> GB</p>

          <div class="selection-actions">
            <button class="btn-small" id="removeLast">Quitar √∫ltimo</button>
            <button class="btn-small danger" id="clearAll">Vaciar selecci√≥n</button>
            <button class="btn-small" id="saveSelection">Guardar selecci√≥n</button>
          </div>

          <p class="selector-note">
            El espacio es aproximado y puede variar seg√∫n el formato del juego.
          </p>
        </div>

      </div>
    </section>

    <!-- CTA -->
    <section>
      <a class="btn" href="/contacto/">Contactar para instalaci√≥n</a>
    </section>

  </div>
</main>

<!-- FOOTER -->
<footer>
  <p>GameTechSolutions ¬© 2026</p>
</footer>

<!-- JS -->
<script>

  
  document.addEventListener('DOMContentLoaded', () => {
  let selectedGames = [];
  let totalSize = 0;
  let diskLimit = null;
  let diskLabel = '';
  let gamesData = [];

  const gameCountEl = document.getElementById('gameCount');
  const totalSizeEl = document.getElementById('totalSize');
  const catalogEl = document.querySelector('.selector-catalog');
  const AIRTABLE_BASE_ID = 'appkHQDb34w1UVd7D'; // tu Base ID
  const AIRTABLE_TABLE = 'Selections';
  const AIRTABLE_TOKEN = 'patdDeAGJ97mmIMMN.11390e00bd32983e440aec50e660a099f9cb207536415ea82c7a7d491106f43f';  // token con write

  const CONSOLE_CONFIG = {
    code: 'PS3',
    name: 'PlayStation 3',
    fullName: 'PlayStation 3',
    gamesJson: '/assets/data/ps3-games.json'
  };

  document.getElementById('consoleName').textContent = CONSOLE_CONFIG.name;    
  document.querySelectorAll('.consoleFull').forEach(el => {
    el.textContent = CONSOLE_CONFIG.fullName;
  });

    document.title = `Cat√°logo de juegos ${CONSOLE_CONFIG.fullName} | GameTechSolutions`;

    /* PAYLOAD */

    document.getElementById('saveSelection').addEventListener('click', async () => {
      if (!selectedGames.length || diskLimit === null) {
        alert('Selecciona el disco duro y al menos un juego.');
        return;
      }
    
      const clientName = prompt('Nombre del cliente:');
      if (!clientName) return;
    
      const selectionId = generateSelectionId(CONSOLE_CONFIG.code);

      const payload = {
        selectionId,
        clientName,
        console: CONSOLE_CONFIG.name,
      
        diskSize: Number(diskLabel),
        diskLimit: diskLimit,
        totalSize: Number(totalSize.toFixed(2)),
      
        // üëá lista humana (para Airtable)
        selectedGames: selectedGames.map(g => {
          const game = gamesData.find(x => Number(x.id) === g.id);
          return game?.name;
        }).filter(Boolean),
      
        // üëá lista estructurada (para Python)
        jsonGames: selectedGames.map(g => {
          const game = gamesData.find(x => Number(x.id) === g.id);
          return {
            id: game.id,
            name: game.name,
            size: game.size
          };
        })
      };
    
      const res = await fetch('/api/save-selection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    
      const result = await res.json();
    
      if (result.success) {
        alert(`‚úÖ Selecci√≥n guardada\nID: ${selectionId}`);
      } else {
        console.error(result);
        alert('‚ùå Error al guardar la selecci√≥n');
      }
    });
  
    /* LIMPIEZA */

  function sanitizeText(text) {
      return text
        .normalize('NFKD')                 // normaliza unicode
        .replace(/[\u0300-\u036f]/g, '')   // elimina acentos raros
        .replace(/[^\x00-\x7F]/g, '')      // elimina no-ASCII
        .replace(/\s+/g, ' ')              // espacios dobles
        .trim();
    }

    function escapeWhatsApp(text) {
      return text
        .replace(/\*/g, '\\*')
        .replace(/_/g, '\\_')
        .replace(/~/g, '\\~')
        .replace(/`/g, '\\`');
    }

  /* =============================
     CARGAR JUEGOS DESDE JSON
  ============================== */
  fetch(CONSOLE_CONFIG.gamesJson)
    .then(res => res.json())
    .then(data => {
      gamesData = data;
      renderCatalog();
    });

  function renderCatalog() {
    gamesData.forEach(game => {
      const item = document.createElement('div');
      item.className = 'selector-item';

      item.innerHTML = `
        <span>${game.name}</span>
        <span>${Number(game.size).toFixed(2)} GB</span>
        <button class="btn-small add-game"
                data-id="${game.id}"
                data-size="${game.size}">
          Agregar
        </button>
      `;

      catalogEl.appendChild(item);
    });

    bindAddButtons();
  }

  function bindAddButtons() {
    document.querySelectorAll('.add-game').forEach(button => {
      button.addEventListener('click', () => {
        const id = Number(button.dataset.id);
        const size = Number(button.dataset.size);

        if (diskLimit === null) {
          alert('Primero selecciona el tama√±o del disco duro.');
          return;
        }

        if (selectedGames.some(g => g.id === id)) return;

        if (totalSize + size > diskLimit) {
          showLimitWarning();
          return;
        }

        selectedGames.push({ id, size });
        totalSize += size;

        button.disabled = true;
        button.textContent = 'Agregado';
        button.classList.add('added');

        updateSummary();
      });
    });
  }

  /* =============================
     DISCO DURO
  ============================== */
  document.querySelectorAll('input[name="diskSize"]').forEach(radio => {
    radio.addEventListener('change', () => {
      diskLimit = Number(radio.dataset.limit);
      diskLabel = radio.value;
      resetSelection();
      updateSummary();
    });
  });

  /* =============================
     CONTROLES
  ============================== */
  document.getElementById('removeLast').addEventListener('click', () => {
    if (!selectedGames.length) return;

    const removed = selectedGames.pop();
    totalSize -= removed.size;

    const btn = document.querySelector(`.add-game[data-id="${removed.id}"]`);
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Agregar';
      btn.classList.remove('added');
    }

    updateSummary();
  });

  document.getElementById('clearAll').addEventListener('click', () => {
    resetSelection();
    updateSummary();
  });

  /* =============================
     CONTADOR
  ============================== */

  function generateSelectionId(consoleCode) {
    const year = new Date().getFullYear();
    const storageKey = `selectionCounter_${consoleCode}_${year}`;
  
    let counter = Number(localStorage.getItem(storageKey)) || 0;
    counter += 1;
  
    localStorage.setItem(storageKey, counter);
  
    return `${consoleCode}-${year}-${String(counter).padStart(3, '0')}`;
  }

  /* =============================
     UTILIDADES
  ============================== */
  function resetSelection() {
    selectedGames = [];
    totalSize = 0;

    document.querySelectorAll('.add-game').forEach(btn => {
      btn.disabled = false;
      btn.textContent = 'Agregar';
      btn.classList.remove('added');
    });

    hideLimitWarning();
  }

  function updateSummary() {
    gameCountEl.textContent = selectedGames.length;
    totalSizeEl.textContent = totalSize.toFixed(2);
    hideLimitWarning();
  }

  function showLimitWarning() {
    if (!document.getElementById('limitWarning')) {
      const p = document.createElement('p');
      p.id = 'limitWarning';
      p.className = 'limit-warning';
      p.textContent =
        '‚ö†Ô∏è Has superado la capacidad del disco. Elimina juegos para continuar.';
      document.querySelector('.selector-summary').appendChild(p);
    }
  }

  function hideLimitWarning() {
    const w = document.getElementById('limitWarning');
    if (w) w.remove();
  }
  });
</script>

</body>
</html>
