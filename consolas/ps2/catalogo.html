<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cat√°logo de juegos | GameTechSolutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/assets/img/favicon.png">

  <!-- Base global -->
  <link rel="stylesheet" href="/styles/theme-base.css">

  <!-- Tema de consola -->
  <link rel="stylesheet" href="/styles/theme-sony.css">
</head>
<body>

<!-- HEADER (inyectado din√°micamente) -->
<div id="header-container"></div>

<!-- CONTENIDO -->
<main>
  <div class="container">

    <!-- INTRO -->
    <section>
      <h2>¬øC√≥mo funciona el cat√°logo?</h2>
      <p>
        Desde aqu√≠ puedes consultar los juegos disponibles para <strong class="consoleFull"></strong>.
        La cantidad final de juegos instalados depende del tama√±o del disco duro
        y del peso de cada t√≠tulo.
      </p>
      <p>
        Este cat√°logo sirve como referencia para que elijas tus juegos
        al momento de contratar el servicio.
      </p>
    </section>

    <!-- NOTAS -->
    <section>
      <h2>Notas importantes</h2>
      <div class="cards-grid">
        <div class="card">
          <h3>üíæ Espacio disponible</h3>
          <p>No todos los juegos caben en todos los discos.</p>
        </div>
        <div class="card">
          <h3>‚ö†Ô∏è Compatibilidad</h3>
          <p>Algunos t√≠tulos pueden requerir configuraciones especiales.</p>
        </div>
        <div class="card">
          <h3>üõ°Ô∏è Garant√≠a</h3>
          <p>Los juegos instalados cuentan con garant√≠a de 30 d√≠as.</p>
        </div>
      </div>
    </section>

    <!-- TOP JUEGOS -->
    <section>
      <h2>Juegos m√°s populares</h2>
      <p>
        Contamos con un amplio cat√°logo que incluye muchos de los t√≠tulos
        m√°s populares de <strong class="consoleFull"></strong>.
      </p>

      <div class="cards-grid">

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps2/top/tony-3.jpg" alt="Tony Hawk">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Tony Hawk's Pro Skater 3</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps2/top/gta-3.jpg" alt="GTA 3">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Grand Theft Auto III</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps2/top/resident-4.jpg" alt="Resident 4">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Resident Evil 4</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps2/top/metal-gear-2.jpg" alt="Metal 2">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Metal Gear Solid 2</h3>
        </div>

        <div class="card cover-card">
          <div class="cover-wrapper">
            <img src="/assets/img/consolas/ps2/top/gta-san-andreas.jpg" alt="GTA SA">
            <div class="cover-overlay">Disponible</div>
          </div>
          <h3>Grand Theft Auto: San Andreas</h3>
        </div>

      </div>
    </section>

    <section>
      <h2>Selecciona el tama√±o de la USB</h2>
      <p>
        Elige el tama√±o de la USB que deseas instalar.
        La capacidad usable es aproximada y considera el espacio del sistema.
      </p>
    
      <div class="disk-selector">
    
        <label class="disk-option">
          <input type="radio" name="diskSize">
          <div>
            <strong>64 GB</strong>
            <span>Recomendado: ~20 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize" value="120" data-limit="105">
          <div>
            <strong>128 GB</strong>
            <span>Recomendado: ~40 juegos</span>
          </div>
        </label>
    
        <label class="disk-option">
          <input type="radio" name="diskSize">
          <div>
            <strong>256 GB</strong>
            <span>Recomendado: ~80 juegos</span>
          </div>
        </label>
    
      </div>
    
      <p class="disk-note">
        üí° La cantidad de juegos es solo una referencia. El l√≠mite real se determina por el espacio en GB.
      </p>
    </section>

    <!-- SELECTOR -->
    <section>
      <h2>Selector de juegos</h2>
      <p>Selecciona los juegos que te gustar√≠a instalar.</p>

      <div class="selector-layout">

        <!-- CAT√ÅLOGO -->
        <div class="selector-catalog">
          <h3>Cat√°logo</h3>

        </div>

        <!-- RESUMEN -->
        <div class="selector-summary">
          <h3>Mi selecci√≥n</h3>

          <p>üéÆ Juegos seleccionados: <strong id="gameCount">0</strong></p>
          <p>üíæ Espacio estimado: <strong id="totalSize">0</strong> GB</p>

          <div class="selection-actions">
            <button class="btn-small" id="removeLast">Quitar √∫ltimo</button>
            <button class="btn-small danger" id="clearAll">Vaciar selecci√≥n</button>
            <button class="btn-small" id="saveSelection">Guardar selecci√≥n</button>
          </div>

          <p class="selector-note">
            El espacio es aproximado y puede variar seg√∫n el formato del juego.
          </p>
        </div>

      </div>
    </section>

    <!-- CTA -->
    <section>
      <a class="btn" href="/contacto/">Contactar para instalaci√≥n</a>
    </section>

  </div>
</main>

<!-- FOOTER -->
<footer>
  <p>GameTechSolutions ¬© 2026</p>
</footer>

  <script>
  window.CONSOLE_CONFIG = {
    code: 'PS2',
    name: 'PlayStation 2',
    short: 'PS2',
    fullName: 'PlayStation 2',
    brand: 'sony',
    gamesJson: '/assets/data/ps2-games.json',
    catalogPath: '/consolas/ps2/catalogo.html'
  };
</script>

<script src="/assets/js/header.js"></script>

<!-- JS -->

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  
    let selectedGames = [];
    let totalSize = 0;
    let diskLimit = null;
    let diskLabel = '';
    let gamesData = [];
  
    const gameCountEl = document.getElementById('gameCount');
    const totalSizeEl = document.getElementById('totalSize');
    const catalogEl = document.querySelector('.selector-catalog');
  
    /* =============================
       TEXTOS DIN√ÅMICOS
    ============================== */
  
    document.title = `Cat√°logo de juegos ${CONSOLE_CONFIG.fullName} | GameTechSolutions`;
  
    document.querySelectorAll('.consoleFull').forEach(el => {
      el.textContent = CONSOLE_CONFIG.fullName;
    });
  
    /* =============================
       CARGAR JUEGOS DESDE JSON
    ============================== */
  
    fetch(CONSOLE_CONFIG.gamesJson)
      .then(res => {
        if (!res.ok) throw new Error('No se pudo cargar el JSON');
        return res.json();
      })
      .then(data => {
        gamesData = data;
        renderCatalog();
      })
      .catch(err => {
        console.error('Error cargando cat√°logo:', err);
        catalogEl.innerHTML = '<p>Error cargando el cat√°logo de juegos.</p>';
      });
  
    function renderCatalog() {
      catalogEl.innerHTML += '';
  
      gamesData.forEach(game => {
        const item = document.createElement('div');
        item.className = 'selector-item';
  
        item.innerHTML = `
          <span>${game.name}</span>
          <span>${Number(game.size).toFixed(2)} GB</span>
          <button class="btn-small add-game"
                  data-id="${game.id}"
                  data-size="${game.size}">
            Agregar
          </button>
        `;
  
        catalogEl.appendChild(item);
      });
  
      bindAddButtons();
    }
  
    function bindAddButtons() {
      document.querySelectorAll('.add-game').forEach(button => {
        button.addEventListener('click', () => {
          const id = Number(button.dataset.id);
          const size = Number(button.dataset.size);
  
          if (diskLimit === null) {
            alert('Primero selecciona el tama√±o del disco duro.');
            return;
          }
  
          if (selectedGames.some(g => g.id === id)) return;
  
          if (totalSize + size > diskLimit) {
            showLimitWarning();
            return;
          }
  
          selectedGames.push({ id, size });
          totalSize += size;
  
          button.disabled = true;
          button.textContent = 'Agregado';
          button.classList.add('added');
  
          updateSummary();
        });
      });
    }
  
    /* =============================
       DISCO DURO
    ============================== */
  
    document.querySelectorAll('input[name="diskSize"]').forEach(radio => {
      radio.addEventListener('change', () => {
        diskLimit = Number(radio.dataset.limit);
        diskLabel = radio.value;
        resetSelection();
        updateSummary();
      });
    });
  
    /* =============================
       CONTROLES
    ============================== */
  
    document.getElementById('removeLast').addEventListener('click', () => {
      if (!selectedGames.length) return;
  
      const removed = selectedGames.pop();
      totalSize -= removed.size;
  
      const btn = document.querySelector(`.add-game[data-id="${removed.id}"]`);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Agregar';
        btn.classList.remove('added');
      }
  
      updateSummary();
    });
  
    document.getElementById('clearAll').addEventListener('click', () => {
      resetSelection();
      updateSummary();
    });

    /* =============================
       GENERAR ID DE SELECCI√ìN
    ============================= */
    
    function generateSelectionId(consoleCode) {
      const year = new Date().getFullYear();
      const storageKey = `selectionCounter_${consoleCode}_${year}`;
    
      let counter = Number(localStorage.getItem(storageKey)) || 0;
      counter += 1;
    
      localStorage.setItem(storageKey, counter);
    
      return `${consoleCode}-${year}-${String(counter).padStart(3, '0')}`;
    }

    /* =============================
       GUARDAR SELECCI√ìN (Airtable)
    ============================= */
    
    const saveBtn = document.getElementById('saveSelection');
    
    if (saveBtn) {
      saveBtn.addEventListener('click', async () => {

        // 1Ô∏è‚É£ Debe haber disco seleccionado
        if (diskLimit === null || Number.isNaN(diskLimit)) {
          alert('Selecciona primero el tama√±o de la USB.');
          return;
        }
        
        // 2Ô∏è‚É£ Debe haber al menos un juego
        if (!selectedGames.length) {
          alert('Selecciona al menos un juego.');
          return;
        }
        
        // 3Ô∏è‚É£ Validaci√≥n REAL de espacio
        if (totalSize > diskLimit) {
          alert(
            `‚ùå La selecci√≥n excede el tama√±o de la USB.\n\n` +
            `Espacio usado: ${totalSize.toFixed(2)} GB\n` +
            `L√≠mite: ${diskLimit} GB\n\n` +
            `Elimina juegos para continuar.`
          );
          return;
        }

        const clientName = prompt('Nombre del cliente:');
        if (!clientName) return;
    
        const selectionId = generateSelectionId(CONSOLE_CONFIG.code);
    
        const payload = {
          selectionID: selectionId,
          clientName: clientName,
          console: CONSOLE_CONFIG.fullName,
          diskSize: Number(diskLabel),
          diskLimit: diskLimit,
          totalSize: Number(totalSize.toFixed(2)),
          CantidadJuegos: selectedGames.length,
    
          selectedGames: selectedGames
            .map(g => {
              const game = gamesData.find(x => Number(x.id) === g.id);
              return game ? game.name : null;
            })
            .filter(Boolean)
            .join('\n'),
    
          jsonGames: JSON.stringify(
            selectedGames.map(g => {
              const game = gamesData.find(x => Number(x.id) === g.id);
              return {
                id: game.id,
                name: game.name,
                size: game.size
              };
            })
          ),
    
          status: 'Pendiente'
        };
    
        try {
          const res = await fetch('/api/save-selection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const errorData = await res.json();
          
            if (errorData?.error === 'Disk limit exceeded') {
              alert(
                `‚ùå La selecci√≥n excede el tama√±o permitido.\n\n` +
                `Usado: ${totalSize.toFixed(2)} GB\n` +
                `L√≠mite: ${diskLimit} GB`
              );
            } else {
              alert('‚ùå Error al guardar la selecci√≥n');
              console.error(errorData);
            }
            return;
          }

          const result = await res.json();
    
          if (result.success) {
            alert(`‚úÖ Selecci√≥n guardada\nID: ${selectionId}`);
          } else {
            console.error(result);
            alert('‚ùå Error al guardar la selecci√≥n');
          }
    
        } catch (err) {
          console.error(err);
          alert('‚ùå Error de conexi√≥n con el servidor');
        }
      });
    }
  
    /* =============================
       UTILIDADES
    ============================== */
  
    function resetSelection() {
      selectedGames = [];
      totalSize = 0;
  
      document.querySelectorAll('.add-game').forEach(btn => {
        btn.disabled = false;
        btn.textContent = 'Agregar';
        btn.classList.remove('added');
      });
  
      hideLimitWarning();
    }
  
    function updateSummary() {
      gameCountEl.textContent = selectedGames.length;
      totalSizeEl.textContent = totalSize.toFixed(2);
      hideLimitWarning();
    
      if (saveBtn) {
        if (diskLimit !== null && totalSize > diskLimit) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Excede el l√≠mite';
          saveBtn.classList.add('danger');
        } else {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Guardar selecci√≥n';
          saveBtn.classList.remove('danger');
        }
      }
    }
  
    function showLimitWarning() {
      if (!document.getElementById('limitWarning')) {
        const p = document.createElement('p');
        p.id = 'limitWarning';
        p.className = 'limit-warning';
        p.textContent =
          '‚ö†Ô∏è Has superado la capacidad del disco. Elimina juegos para continuar.';
        document.querySelector('.selector-summary').appendChild(p);
      }
    }
  
    function hideLimitWarning() {
      const w = document.getElementById('limitWarning');
      if (w) w.remove();
    }
  
  });
  </script>
</body>
</html>
