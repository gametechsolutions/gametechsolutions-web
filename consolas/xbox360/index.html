<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Xbox 360 | GameTechSolutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" href="/assets/img/favicon.png" />
  <link rel="stylesheet" href="/styles/theme-base.css" />
  <link rel="stylesheet" href="/styles/theme-microsoft.css" />
</head>
<body>

<!-- HEADER -->
<div id="header-container"></div>

<main>
  <div class="container">

    <!-- INTRO -->
    <section>
      <h2>Servicio para Xbox 360</h2>
      <p>Selecciona el modelo de tu consola y los servicios que necesitas.</p>
    </section>

    <!-- =========================
         1. MODELO
    ========================== -->
    <section>
      <h2>1Ô∏è‚É£ Identifica tu modelo</h2>
      <div class="cards-grid" id="modelsContainer"></div>
    </section>

    <!-- =========================
         2. SERVICIOS
    ========================== -->
    <section>
      <h2>2Ô∏è‚É£ Selecciona los servicios</h2>
      <div class="cards-grid" id="servicesContainer"></div>
    </section>

    <!-- =========================
         AVISO RGH + MODELO E
    ========================== -->
    <section id="rghNotice" style="display:none">
      <div class="alert warning">
        ‚ö†Ô∏è <strong>Xbox 360 Modelo E</strong><br><br>
        No todos los modelos E son compatibles con RGH.
        La compatibilidad final se confirma √∫nicamente mediante
        <strong>revisi√≥n f√≠sica</strong>.
      </div>
    </section>

    <!-- =========================
         3. ALMACENAMIENTO
    ========================== -->
    <section id="storageSection" style="display:none">
      <h2>3Ô∏è‚É£ Almacenamiento</h2>
      <p id="storageHelp" class="selector-note"></p>

      <div class="disk-selector" id="storageOptions"></div>
    </section>

    <!-- CTA -->
    <section style="text-align:center; margin-top:30px">
      <button class="btn" id="continueBtn" disabled>
        Siguiente paso ‚Üí
      </button>
    </section>

  </div>
</main>

<footer>
  <p>GameTechSolutions ¬©Ô∏è 2026</p>
</footer>

<script>
  window.CONSOLE_CONFIG = {
    code: 'X360',
    name: 'Xbox 360',
    brand: 'microsoft'
  };
</script>

<script src="/assets/js/context.js"></script>
<script src="/assets/js/header.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  const ctxAPI = window.GTSContext;

  /* =============================
     MODELOS
  ============================== */

  fetch('/assets/data/identificar/xbox360.json')
    .then(r => r.json())
    .then(data => {
      const container = document.getElementById('modelsContainer');
      container.innerHTML = '';

      data.models.forEach(model => {
        const card = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <h3>${model.name}</h3>
          <p>${model.notes || ''}</p>
          ${model.image ? `<img src="${model.image}" class="identify-img">` : ''}
          <button class="btn btn-outline">Seleccionar</button>
        `;

        card.querySelector('button').onclick = () => {
          ctxAPI.save({
            console: window.CONSOLE_CONFIG,
            model: { id: model.id, description: model.name }
          });
          updateRGHNotice();
          checkReady();
        };

        container.appendChild(card);
      });
    });

  /* =============================
     SERVICIOS
  ============================== */

  const EXCLUSIVE_STORAGE_SERVICES = [
    'games_only',
    'storage_with_games'
  ];

  const servicesData = await fetch('/assets/data/services.json').then(r => r.json());
  const services = Object.values(servicesData.X360.services);

  const servicesContainer = document.getElementById('servicesContainer');
  const selectedServices = new Set();

  services.forEach(service => {
    const card = document.createElement('div');
    card.className = 'card';

    card.innerHTML = `
      <h3>${service.name}</h3>
      <p>${service.description}</p>
      <button class="btn btn-outline" data-service-id="${service.id}">
        Agregar
      </button>
    `;

    const btn = card.querySelector('button');

    btn.onclick = () => {
      if (selectedServices.has(service.id)) {
        selectedServices.delete(service.id);
        btn.textContent = 'Agregar';
      } else {
      
        // üîí Exclusi√≥n l√≥gica: storage + juegos
        if (EXCLUSIVE_STORAGE_SERVICES.includes(service.id)) {
          EXCLUSIVE_STORAGE_SERVICES.forEach(exId => {
            if (selectedServices.has(exId)) {
              selectedServices.delete(exId);
      
              // resetear texto del bot√≥n visual
              const otherBtn = document.querySelector(
                `[data-service-id="${exId}"]`
              );
              if (otherBtn) otherBtn.textContent = 'Agregar';
            }
          });
        }
      
        selectedServices.add(service.id);
        btn.textContent = 'Quitar';
      }

      ctxAPI.save({ services: Array.from(selectedServices) });

      updateStorageUI();
      updateRGHNotice();
      checkReady();
    };

    servicesContainer.appendChild(card);
  });

  /* =============================
     RGH + MODELO E
  ============================== */

  function updateRGHNotice() {
    const ctx = ctxAPI.load();
    const notice = document.getElementById('rghNotice');

    notice.style.display =
      ctx.model?.id === 'e' && ctx.services?.includes('rgh_install')
        ? 'block'
        : 'none';
  }

  /* =============================
     ALMACENAMIENTO DIN√ÅMICO
  ============================== */

  const storageSection = document.getElementById('storageSection');
  const storageOptions = document.getElementById('storageOptions');
  const storageHelp = document.getElementById('storageHelp');

  function updateStorageUI() {
    const ctx = ctxAPI.load();
    storageOptions.innerHTML = '';
    storageSection.style.display = 'none';
  
    if (!ctx.services?.length) return;
  
    // servicios seleccionados que permiten juegos
    const activeGameServices = services.filter(
      s => ctx.services.includes(s.id) && s.allowsGames
    );
  
    if (!activeGameServices.length) return;
  
    storageSection.style.display = 'block';
  
    // ¬øel cliente ya tiene disco o t√∫ lo proporcionas?
    const hasClientDisk = activeGameServices.some(s => s.id === 'games_only');
    const hasProvidedDisk = activeGameServices.some(s => s.id === 'storage_with_games');
  
    storageHelp.textContent = hasClientDisk
      ? 'Selecciona el tama√±o del disco duro que ya tiene tu consola.'
      : 'Selecciona el disco duro que deseas instalar con juegos.';
  
    const sizes = hasClientDisk
      ? { 120:110, 250:230, 320:293, 500:465, 1000:930 }
      : { 500:465, 1000:930 };
  
    Object.entries(sizes).forEach(([size, usable]) => {
      const label = document.createElement('label');
      label.className = 'disk-option';
  
      label.innerHTML = `
        <input type="radio" name="diskSize" value="${size}">
        <strong>${size} GB</strong>
      `;
  
      label.querySelector('input').onchange = () => {
        ctxAPI.save({
          storage: { label: `${size} GB`, usableGB: usable }
        });
        checkReady();
      };
  
      storageOptions.appendChild(label);
    });
  }

  /* =============================
     CONTINUAR
  ============================== */

  function needsCatalog(ctx) {
    return ctx.services?.some(id => {
      const svc = services.find(s => s.id === id);
      return svc?.allowsGames;
    });
  }

  function checkReady() {
    const ctx = ctxAPI.load();
    const ready =
      ctx.model &&
      ctx.services?.length &&
      (!needsCatalog(ctx) || ctx.storage);

    document.getElementById('continueBtn').disabled = !ready;
  }

  document.getElementById('continueBtn').onclick = () => {
    const ctx = ctxAPI.load();
    window.location.href = needsCatalog(ctx)
      ? '/consolas/xbox360/catalogo.html'
      : '/contacto/';
  };

});
</script>

</body>
</html>
