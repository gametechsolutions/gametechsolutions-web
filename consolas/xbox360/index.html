<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Xbox 360 | GameTechSolutions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" href="/assets/img/favicon.png" />
  <link rel="stylesheet" href="/styles/theme-base.css" />
  <link rel="stylesheet" href="/styles/theme-microsoft.css" />
</head>
<body>

<div id="header-container"></div>

<main>
  <div class="container">

    <section>
      <h2>Servicio para Xbox 360</h2>
      <p>Selecciona el modelo de tu consola y los servicios que necesitas.</p>
    </section>

    <!-- MODELO -->
    <section class="identify-step">
      <h2>Identifica tu modelo</h2>
      <div class="cards-grid" id="modelsContainer"></div>
    </section>

    <!-- SERVICIOS -->
    <section class="identify-step">
      <h2>Selecciona los servicios</h2>
      <div class="cards-grid" id="servicesContainer"></div>
    </section>

    <!-- AVISO RGH -->
    <section id="rghNotice" style="display:none">
      <div class="alert warning">
        ⚠️ <strong>Xbox 360 Modelo E</strong><br><br>
        No todos los modelos E son compatibles con RGH.
        La compatibilidad se confirma mediante revisión física.
      </div>
    </section>

    <!-- STORAGE -->
    <section id="storageSection" style="display:none">
      <h2>Almacenamiento</h2>
      <p id="storageHelp" class="selector-note"></p>
      <div class="disk-selector" id="storageOptions"></div>
    </section>

    <!-- CONTINUAR -->
    <section style="text-align:center; margin-top:30px">
      <button class="btn" id="continueBtn">
        Siguiente paso →
      </button>
    </section>

  </div>
</main>

<footer>
  <p>GameTechSolutions ©️ 2026</p>
</footer>

<script>
  window.CONSOLE_CONFIG = {
    code: 'X360',
    name: 'Xbox 360',
    brand: 'microsoft'
  };
</script>

<script src="/assets/js/context.js"></script>
<script src="/assets/js/header.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  const ctxAPI = window.GTSContext;

  /* =============================
     HELPERS
  ============================== */

  function getStorageMode(services = []) {
    if (services.includes('games_only')) return 'client';
    if (services.includes('storage_with_games')) return 'provided';
    return null;
  }

  function needsCatalog(ctx) {
    return ctx.services?.some(id =>
      services.find(s => s.id === id)?.allowsGames
    );
  }

  function validateBeforeContinue() {
    const ctx = ctxAPI.load();

    if (!ctx.model) {
      alert('Debes seleccionar el modelo de tu consola.');
      return false;
    }

    if (!ctx.services?.length) {
      alert('Debes seleccionar al menos un servicio.');
      return false;
    }

    if (needsCatalog(ctx) && !ctx.storage) {
      alert('Debes seleccionar el tamaño del almacenamiento.');
      return false;
    }

    return true;
  }

  function showRGHWarningIfNeeded() {
    const ctx = ctxAPI.load();
  
    const needsGames = ctx.services?.some(id =>
      ['games_only', 'storage_with_games'].includes(id)
    );
  
    const hasRGH = ctx.services?.includes('rgh_install');
  
    if (needsGames && !hasRGH) {
      alert(
        'ℹ️ Para cargar juegos se requiere RGH.\n' +
        'La compatibilidad se confirma tras revisión física.'
      );
    }
  }

  /* =============================
     MODELOS
  ============================== */

  const modelsData = await fetch('/assets/data/identificar/xbox360.json')
    .then(r => r.json());

  const modelsContainer = document.getElementById('modelsContainer');

  modelsData.models.forEach(model => {
    const card = document.createElement('div');
    card.className = 'card';

    card.innerHTML = `
      <h3>${model.name}</h3>
      <p>${model.notes || ''}</p>
      ${model.image ? `<img src="${model.image}" class="identify-img">` : ''}
      <button class="btn btn-outline">Seleccionar</button>
    `;

    card.querySelector('button').onclick = () => {
      ctxAPI.save({
        console: window.CONSOLE_CONFIG,
        model: { id: model.id, description: model.name }
      });

      updateRGHNotice();
      updateStorageUI();
    };

    modelsContainer.appendChild(card);
  });

  /* =============================
     SERVICIOS
  ============================== */

  const servicesData = await fetch('/assets/data/services.json')
    .then(r => r.json());

  const services = servicesData.X360.services;
  const servicesContainer = document.getElementById('servicesContainer');
  const selectedServices = new Set();

  const EXCLUSIVE_STORAGE_SERVICES = ['games_only', 'storage_with_games'];

  services.forEach(service => {
    const card = document.createElement('div');
    card.className = 'card';

    card.innerHTML = `
      <h3>${service.name}</h3>
      <p>${service.description}</p>
      <button class="btn btn-outline" data-id="${service.id}">
        Agregar
      </button>
    `;

    const btn = card.querySelector('button');

    btn.onclick = () => {
      const prevCtx = ctxAPI.load();

      if (!prevCtx.model) {
        alert('Primero selecciona el modelo de tu consola.');
        return;
      }

      if (selectedServices.has(service.id)) {
        selectedServices.delete(service.id);
        btn.textContent = 'Agregar';
      } else {

        if (EXCLUSIVE_STORAGE_SERVICES.includes(service.id)) {
          EXCLUSIVE_STORAGE_SERVICES.forEach(id => {
            if (selectedServices.has(id)) {
              selectedServices.delete(id);
              const otherBtn =
                document.querySelector(`[data-id="${id}"]`);
              if (otherBtn) otherBtn.textContent = 'Agregar';
            }
          });
        }

        selectedServices.add(service.id);
        btn.textContent = 'Quitar';
      }

      const nextServices = Array.from(selectedServices);
      const prevMode = getStorageMode(prevCtx.services);
      const nextMode = getStorageMode(nextServices);

      ctxAPI.save({
        services: nextServices,
        storage: prevMode !== nextMode ? null : prevCtx.storage
      });

      updateStorageUI();
      updateRGHNotice();
    };

    servicesContainer.appendChild(card);
  });

  /* =============================
     RGH + MODELO E
  ============================== */

  function updateRGHNotice() {
    const ctx = ctxAPI.load();
    document.getElementById('rghNotice').style.display =
      ctx.model?.id === 'e' &&
      ctx.services?.includes('rgh_install')
        ? 'block'
        : 'none';
  }

  /* =============================
     STORAGE
  ============================== */

  const storageSection = document.getElementById('storageSection');
  const storageOptions = document.getElementById('storageOptions');
  const storageHelp = document.getElementById('storageHelp');

  function updateStorageUI() {
    const ctx = ctxAPI.load();

    storageOptions.innerHTML = '';
    storageSection.style.display = 'none';

    if (!needsCatalog(ctx)) return;

    storageSection.style.display = 'block';

    const mode = getStorageMode(ctx.services);

    storageHelp.textContent =
      mode === 'client'
        ? 'Selecciona el disco duro que ya tiene tu consola.'
        : 'Selecciona el disco duro que deseas instalar.';

    const sizes =
      mode === 'client'
        ? {120:105,250:226,320:293,500:460,1000:926}
        : {500:460,1000:926};

    Object.entries(sizes).forEach(([size, usable]) => {
      const label = document.createElement('label');
      label.className = 'disk-option';

      label.innerHTML = `
        <input type="radio" name="diskSize">
        <strong>${size} GB</strong>
      `;

      label.querySelector('input').onchange = () => {
        ctxAPI.save({
          storage: { label: `${size} GB`, usableGB: usable }
        });
      };

      storageOptions.appendChild(label);
    });
  }

  /* =============================
     CONTINUAR
  ============================== */

  document.getElementById('continueBtn').onclick = () => {
    if (!validateBeforeContinue()) return;

    showRGHWarningIfNeeded();

    const ctx = ctxAPI.load();
    window.location.href = needsCatalog(ctx)
      ? '/consolas/xbox360/catalogo.html'
      : '/contacto/';
  };

});
</script>

</body>
</html>
